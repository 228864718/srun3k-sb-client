<!DOCTYPE html>
<html lang="zh-cn">
	<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta name="author" content="Zengxs,Noisky">
	<meta name="copyright" content="Noisky&#39;s Laboratory">
	<meta name="ViewPort" content="initial-scale=1, minimum-scale=1, width=device-width">
	<meta name="HandheldFriendly" content="true">
	<meta name="renderer" content="webkit">
	<title>校园网登录器</title>
	<link rel="shortcut icon" type="image/png" href="data:img/jpg;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAQAAABKfvVzAAABK0lEQVR4Ab3LwUpUYRwF8N+92r29iKKPUKDSovYFSsOEGxd3UNf1DIFQQUHPYOajyOCuKG3SeoTuzGz+wV18MB/T3QT+zurAOe7cffvO/TQ398OZoUqPgd8iy41dS5U+CuFCY02lsm5kLIT3Srlu/seBRYVG210yg26+ZZkdrbCLpPZLOPAvI+FGJdkXLsAbMyew0ApjYSg5FxowE1rI2qHwSTIR1sCJ1mvI2oZwLZkLlT61MPuPw0RY12dTuJJ8FkZY9V1k+WIFx8Kp5IUwVmDbdGHeeoDCpTCQ1G6FBmz7luZfPQRHwkQlYU9o7YBVT7zy0mMr4JGp8Ezmg9BqFBIUjrr5OzlldwljhzbUapuOXQrhrdJSe25FlomnetSGzlybmbpy6rl77thfv0iYemrko00AAAAASUVORK5CYII=">
	<!--The Srun Offical JavaScript-->
	<script src="http://172.16.154.130/static/bower/all/1.0.0/all.min.js?v=2.00.20180614"></script>
	<script src="http://172.16.154.130/static/js/jquery.srun.portal.js?v=2.00.20180614"></script>
	<script>
		/*! jquery.cookie v1.4.1 | MIT */
		!function(a){"function"==typeof define&&define.amd?define(["jquery"],a):"object"==typeof exports?a(require("jquery")):a(jQuery)}(function(a){function b(a){return h.raw?a:encodeURIComponent(a)}function c(a){return h.raw?a:decodeURIComponent(a)}function d(a){return b(h.json?JSON.stringify(a):String(a))}function e(a){0===a.indexOf('"')&&(a=a.slice(1,-1).replace(/\\"/g,'"').replace(/\\\\/g,"\\"));try{return a=decodeURIComponent(a.replace(g," ")),h.json?JSON.parse(a):a}catch(b){}}function f(b,c){var d=h.raw?b:e(b);return a.isFunction(c)?c(d):d}var g=/\+/g,h=a.cookie=function(e,g,i){if(void 0!==g&&!a.isFunction(g)){if(i=a.extend({},h.defaults,i),"number"==typeof i.expires){var j=i.expires,k=i.expires=new Date;k.setTime(+k+864e5*j)}return document.cookie=[b(e),"=",d(g),i.expires?"; expires="+i.expires.toUTCString():"",i.path?"; path="+i.path:"",i.domain?"; domain="+i.domain:"",i.secure?"; secure":""].join("")}for(var l=e?void 0:{},m=document.cookie?document.cookie.split("; "):[],n=0,o=m.length;o>n;n++){var p=m[n].split("="),q=c(p.shift()),r=p.join("=");if(e&&e===q){l=f(r,g);break}e||void 0===(r=f(r))||(l[q]=r)}return l};h.defaults={},a.removeCookie=function(b,c){return void 0===a.cookie(b)?!1:(a.cookie(b,"",a.extend({},c,{expires:-1})),!a.cookie(b))}});
	</script>
	<!--The Style Sheet Created by noisky-->
	<style type="text/css">
		html,body{width:100%;height:100%;cursor:default}html,body,p,h2,div{text-align:center;margin:0;padding:0}body{background:#2980b9;text-align:center;user-select:none;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;margin:0 auto}html{font:12px "Segoe UI","Microsoft YaHei",FreeSans,Arimo,"Droid Sans","Hiragino Sans GB","Hiragino Sans GB W3",Arial,sans-serif}h2{margin-bottom:25px;font-size:30px;font-weight:300;color:#e05d6f}p{line-height:1.5em;font-size:12px;color:#95a2a9;margin-bottom:5px}.title{position:relative;top:75px;margin-bottom:.7em;line-height:30px;font-size:26px;font-weight:300;color:#fff;text-shadow:0 0 4px #666}.box{position:relative;top:80px;width:600px;max-width:85%;margin:0 auto;background:#fff;padding:15px;box-shadow:0 0 50px #2964b9}.main{font-size:18px;color:#000;font-weight:500;line-height:1.7em;margin:0 0 10px}.foot{position:relative;top:80px;margin:15px 15px 0;font-size:12px;color:#4eb0f8}pre{background:#3498db;color:#fff;padding:15px 20px;margin:25px -15px -15px;line-height:1.4em;font-size:14px;text-align:left;word-break:break-all;white-space:pre-wrap;text-align: center;}a{color:lightblue;text-decoration:none}.m{padding:20px 0 8px 0}.ui input[type=text],.ui input[type=password],.ui input[type=number]{margin:0;outline:0;-webkit-appearance:none;tap-highlight-color:rgba(255,255,255,0);line-height:1.2142em;padding:.67861429em 1em;background:#FFF;border:1px solid rgba(34,36,38,.15);color:rgba(0,0,0,.87);border-radius:.28571429rem;box-shadow:0 0 0 0 transparent inset;-webkit-transition:color .1s ease,border-color .1s ease;transition:color .1s ease,border-color .1s ease}.ui input:focus{border-style:solid;border-color:#03a9f4}.field{clear:both;margin:0 0 1em;font-size:18px}.ui.button{cursor:pointer;display:inline-block;min-height:1em;outline:0;border:0;vertical-align:baseline;background:#2185d0;color:#fff;margin:0 25px;padding:.78571429em 1.5em;text-transform:none;text-shadow:none;font-weight:700;font-size:15px;line-height:1em;font-style:normal;text-decoration:none;border-radius:.28571429rem;box-shadow:0 0 0 0 rgba(34,36,38,.15) inset;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;-webkit-transition:opacity .1s ease,background-color .1s ease,color .1s ease,box-shadow .1s ease,background .1s ease;transition:opacity .1s ease,background-color .1s ease,color .1s ease,box-shadow .1s ease,background .1s ease;will-change:'';-webkit-tap-highlight-color:transparent}.ui.button:hover{background-color:#1678c2;box-shadow:0 0 0 1px transparent inset,0 0 0 0 rgba(34,36,38,.15) inset}.ui.red.button{background:#e05d6f}.ui.red.button:hover{background-color:#bb515f;box-shadow:0 0 0 1px transparent inset,0 0 0 0 rgba(34,36,38,.15) inset}.ui.set.button{font-size:12px;background:#3498db;padding:.9em 1.1em}.ui.set.button:hover{background-color:#287ab1;box-shadow:0 0 0 1px transparent inset,0 0 0 0 rgba(34,36,38,.15) inset}.aleft{float:left}.acenter{float:none}.aright{float:right}.aset{color:#000;text-decoration:underline}
	</style>
	<!--New Srun3k web client-->
	<script>
		var used_time=0;
		var TimerID=null;
		var CheckCookies;
		$(document).ready(function(){
			GetStatus();	
			//TODO:检查COOKIE是否存在，存在则读取并且设置标志位
		});
		function ShowBox(status){if(status=="online"){$("#login_box").css({display:"none",visibility:"hidden"});$("#message_box").css({display:"none",visibility:"hidden"});$("#error_box").css({display:"none",visibility:"hidden"});$("#logout_box").css({display:"inline",visibility:"visible"})}else{if(status=="offline"){$("#logout_box").css({display:"none",visibility:"hidden"});$("#message_box").css({display:"none",visibility:"hidden"});$("#error_box").css({display:"none",visibility:"hidden"});$("#login_box").css({display:"inline",visibility:"visible"})}else{if(status=="error"){$("#logout_box").css({display:"none",visibility:"hidden"});$("#message_box").css({display:"none",visibility:"hidden"});$("#login_box").css({display:"none",visibility:"hidden"});$("#error_box").css({display:"inline",visibility:"visible"})}}}};
//     由于学校系统公告公告系统使用JSON返回公告，而JSON不支持跨域，故取消此功能。
// 		function GetMessage() {
// 			$.ajax({
// 				url:'http://172.16.154.130/v2/srun_portal_message',
// 				method:'get',
// 				dataType:'jsonp',
// 				jsonp: 'callback',//使用默认的回调函数callback
// 				timeout:1000, //超时设置，默认ajax不设置
// 				success: function(data) {
// 					//can not do any thing		
//                 },
//                 error: function(XMLHttpRequest, textStatus, errorThrown) {   
// 					//处理网络情况
// 					ShowBox('error');
// 				},
// 			});
// 	    }
	function GetStatus() {
		$("#statusbar").text("正在获取状态...")
		$.ajax({
				url:'http://172.16.154.130/cgi-bin/rad_user_info',
				method:'get',
				dataType:'jsonp',
				jsonp: 'callback',//使用默认的回调函数callback
				timeout:1000, //超时设置，默认ajax不设置
				success: function(data) {
					$("#statusbar").text("正在获取状态...成功！")
					$("pre").css("background","#1aad18");
					if(data.ecode==0&&data.error=='not_online_error') {
						//不在线处理
						ShowBox('offline');
					}	
					else if(data.error=='ok') {
						//在线处理
						$("#user_name").text(data.user_name);
						$("#ip").text(data.online_ip);
						$("#used_flow").text(formatFlux(data.sum_bytes));
						//总时间（显示时间）=sum_seconds+Math.round(new Date().getTime()/1000)-add_time
						used_time=data.sum_seconds+Math.round(new Date().getTime()/1000)-data.add_time;
						//然后使用一个定时器每次+1s并解析，注销时候断开该定时器
						TimerID=self.setInterval(RefreshTime,1000);
						ShowBox('online');
					}
                },
                error: function(XMLHttpRequest, textStatus, errorThrown) {   
					//处理网络情况
					ShowBox('error');
				},
		});
	}
	function RefreshTime() {
		var h=Math.floor(used_time/3600);
		var m=Math.floor(used_time/60)%60;
		var s=used_time%60;
		var display=h+" 时 "+m+" 分 "+s+" 秒 ";
		$("#used_time").text(display);
		user_time=used_time++;
	}
	
    /*
     * Format No.
     */
	 function formatNumber(num, count) {
        var n = Math.pow(10, count),
            t = Math.floor(num * n);
        return t / n;
    }

    /*
     * Format Flux
     */
    function formatFlux(byte) {
        if (byte > (1000 * 1000))
            return (formatNumber((byte / (1000 * 1000)), 2) + " MB");
        if (byte > 1000)
            return (formatNumber((byte / 1000), 2) + " KB");
        return byte + " B";
    }

	function selfService(){
			$("#statusbar").text("正在打开自服务...")
			$("pre").css("background","#3498db");
			var username = $("#username").val();
			var password = $("#password").val();
			if (typeof username != "undefined" && username != "") {
			var ALPHA = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",
        		base64 = $.base64;
        	base64.setAlpha(ALPHA);
        	var data = "";
        	if (typeof password != "undefined" && password != "") {
        		var pwd = md5(password);
        		data = base64.encode(username+":"+pwd);
        	}
        	data = base64.encode(username+":"+username);
			console.log(data);
        	if (data != "") {
        		window.open("http://172.16.154.130:8800/site/sso?data="+data);
				$("pre").css("background","#1aad18");
				$("#statusbar").text("正在打开自服务...成功！")
        		return;
        	}
			$("pre").css("background","#1aad18");
			$("#statusbar").text("正在打开自服务...成功！")
        	window.open("http://172.16.154.130:8800");
			return;
		}
		window.open("http://172.16.154.130:8800");
		$("pre").css("background","#1aad18");
		$("#statusbar").text("正在打开自服务...成功！")
	}
		
	var acid = '1';
	function username_encrypt(username) {
		var username_crypto = "";
		for (var i = 0; i < username.length; ++i) {
			username_crypto += String.fromCharCode(username.charCodeAt(i) + 4);
		}
		return "{SRUN3}\r\n" + username_crypto;
	}

	function password_encrypt(password) {
		var key = '1234567890';
		var password_crypto = "";
		for (var i = 0; i < password.length; ++i) {
			var ki = password.charCodeAt(i) ^ key.charCodeAt(key.length - i % key.length - 1);
			var _l = String.fromCharCode((ki & 0x0f) + 0x36);
			var _h = String.fromCharCode((ki >> 4 & 0x0f) + 0x63);
			if (i % 2 == 0) {
				password_crypto += _l + _h;
			} else {
				password_crypto += _h + _l;
			}
		}
		return password_crypto;
	}

	function Login(){
		//username is empty
			var username = $("#username").val();
			if (username == "") {
				$("#username").focus();
				$("#statusbar").text("请输入您的用户名以便登录！");
				$("pre").css("background","#E05D6F");
				return;
			}
		//password is empty
			var password = $("#password").val();
			if (password == "") {
				$("#password").focus();
				$("#statusbar").text("请输入您的密码以便登录！");
				$("pre").css("background","#E05D6F");
				return;
			}
			$("#statusbar").text("正在登录...")
			$("pre").css("background","#3498db");
			username = username_encrypt(username);
			//password = password_encrypt(password);
			//var acid = $("#ac_id").val();
			var params = {
				action:"login",
				username:username,
				password:password,
				ac_id:acid,
				type:"10",
				mac:"02:00:00:00:00:00"
			};
			$.Login("http://172.16.154.130", params, function(data) {
				if (data.error == "ok") {
					$("pre").css("background","#1aad18");
					$("#statusbar").text("正在登录...成功！")
					GetStatus();
					//TODO:检查保存登录信息是否存在，如果原来不存在勾选，则保存，如果存在不勾选则删除。
					return;
				} else {
					if (data.message == "IpAlreadyOnlineError") {
						$("#statusbar").text("当前IP已在线，无须再登录")
						$("pre").css("background: #E05D6F;")
						GetStatus();
					} else {
						if (data.message == "INFOFailedBASRespondTimeout") {
							//console.log(data.message);
							acid = '2';
							$("pre").css("background","#1aad18");
							$("#statusbar").text("ACID错误...正在自动重试！")
							Login();
							return;
						}
						if (data.message == "NoResponseDataError") {
							ShowBox('error');
						//showLog(username);
							return;
						}
						//Show Error Message
						//alert(data.message);
						$("#statusbar").text("登陆失败，请检查系统返回原因！");
					    $("pre").css("background","#E05D6F");
						showErrorMessage(data.message);
					}
				}
			});
		};
		
		function Logout(){
			$("#statusbar").text("正在注销...")
			$("pre").css("background","#3498db");
			var username = $("#user_name").text();
			username = username_encrypt(username);
			var params = {
				username:username,
				ac_id:acid,
				mac:'',
				type:'2',
				action:'logout'
			};
			$.Logout("http://172.16.154.130", params, function(data) {
				if (data.error == "ok") {
					$("pre").css("background","#1aad18");
					$("#statusbar").text("正在注销...成功！");
					window.clearInterval(TimerID);
					ShowBox('offline');
					return;
				} else {
					if (data.message == "NoResponseDataError") {
						//showLog(username);
						ShowBox('error')
						return;
					}
				//Show Error Message
					$("#statusbar").text("登陆失败，请检查系统返回原因！");
					$("pre").css("background","#E05D6F");
					showErrorMessage(data.message);
				}
			});
		}
		function showErrorMessage(error, success, redirect) {
			var icon = 2;
			if (typeof success != "undefined" || success) {
				icon = 1
			}
			var message = error;
			if (typeof(errorCode[error]) != "undefined") {
				message = errorCode[error];
			}
			if (typeof redirect != "undefined" && redirect) {
				layer.alert(message, { icon: icon, skin: 'layui-layer-molv', btn:[(errorCode['OK']||"OK")], title:errorCode['Info']||"Ingo" }, function(){
				//location.href = "./";
				});
				return;
			}
			layer.alert(message, { icon: icon, skin: 'layui-layer-molv', btn:[(errorCode['OK']||"OK")], title:errorCode['Info']||"Info" });
		}
	</script>
	<script>
			var errorCode = {
				E0000: "登录成功",
				E2416: "Callback",
				E2417: "User-Error",
				E2531: "用户不存在",
				E2532: "您的两次认证的间隔太短,请稍候10秒后再重试登录",
				E2533: "密码错误次数超过限制，请5分钟后再重试登录",
				E2534: "有代理行为被暂时禁用",
				E2535: "认证系统已经被禁用",
				E2536: "授权已过期",
				E2553: "帐号或密码错误",
				E2601: "您使用的不是专用客户端,IPOE-PPPoE混杂模式请联系管理员重新打包客户端程序",
				E2602: "您还没有绑定手机号或绑定的非联通手机号码",
				E2606: "用户被禁用",
				E2607: "接口被禁用",
				E2611: "您当前使用的设备非该账号绑定设备 请绑定或使用绑定的设备登入",
				E2613: "NAS PORT绑定错误",
				E2614: "MAC地址绑定错误",
				E2615: "IP地址绑定错误",
				E2616: "用户已欠费",
				E2620: "已经在线了",
				E2621: "已经达到授权人数",
				E2806: "找不到符合条件的产品",
				E2807: "找不到符合条件的计费策略",
				E2808: "找不到符合条件的控制策略",
				E2833: "IP不在DHCP表中，需要重新拿地址。",
				E2840: "校内地址不允许访问外网",
				E2841: "IP地址绑定错误",
				E2842: "IP地址无需认证可直接上网",
				E2843: "IP地址不在IP表中",
				E2844: "IP地址在黑名单中",
				E2901: "第三方认证接口返回的错误信息",
				/*extend errorCode*/
				E6500: "认证程序未启动",
				E6501: "用户名输入错误",
				E6502: "注销时发生错误，或没有帐号在线",
				E6503: "您的账号不在线上",
				E6504: "注销成功，请等1分钟后登录",
				E6505: "您的MAC地址不正确",
				E6506: "用户名或密码错误，请重新输入",
				E6507: "您无须认证，可直接上网",
				E6508: "您已欠费，请尽快充值",
				E6509: "您的资料已被修改正在等待同步，请2钟分后再试。如果您的帐号允许多个用户上线，请到WEB登录页面注销",
				E6510: "您的帐号已经被删除",
				E6511: "IP已存在，请稍后再试",
				E6512: "在线用户已满，请稍后再试",
				E6513: "正在注销在线账号，请重新连接",
				E6514: "你的IP地址和认证地址不附，可能是经过小路由器登录的",
				E6515: "系统已禁止客户端登录，请使用WEB方式登录",
				E6516: "您的流量已用尽",
				E6517: "您的时长已用尽",
				E6518: "您的IP地址不合法，可能是：一、与绑的IP地址附；二、IP不允许在当前区域登录",
				E6519: "当前时段不允许连接",
				E6520: "抱歉，您的帐号已禁用",
				E6521: "您的IPv6地址不正确，请重新配置IPv6地址",
				E6522: "客户端时间不正确，请先同步时间（或者是调用方传送的时间格式不正确，不是时间戳；客户端和服务器之间时差超过2小时，括号里面内容不要提示给客户）",
				E6523: "认证服务无响应",
				E6524: "计费系统尚未授权，目前还不能使用",
				E6525: "后台服务器无响应;请联系管理员检查后台服务运行状态",
				E6526: "您的IP已经在线;可以直接上网;或者先注销再重新认证",
				E6527: "当前设备不在线",
				E6528: "您已经被服务器强制下线",
				E6529: "身份验证失败，但不返回错误消息",
				//new errorCode
				ChallengeExpireError: "Challenge时间戳错误",
				SignError: "签名错误",
				NotOnlineError: "当前设备不在线",
				VcodeError: "验证码错误",
				SpeedLimitError: "认证请求太频繁，请稍后10s重试",
				SrunPortalServerError: "Portal服务请求错误",
				AuthResaultTimeoutErr: "Portal服务请求超时",
				IpAlreadyOnlineError: "本机IP已经使用其他账号登陆在线了",
				MemoryDbError: "SRun认证服务(srun_portal_server)无响应",
				GetVerifyCode: "获取验证码",
				S: "秒",
				INFOFailedBASRespondTimeout: "AC_ID错误，BAS无响应",
				LogoutOK: "DM下线成功",
				Info: "信息",
				OK: "确认",
				CheckServerTimestamp:"检查服务器时间",
				TimestampError: "时间戳错误",
				TypeError: "加密类型错误",
				VerifyCodeError: "验证码错误",
				ACIDIsRequired: "缺少ACID",
				ACIDIsEmpty: "缺少ACID",
				BSSIDIsEmpty: "缺少BSSID",
				MACIsEmpty: "缺少MAC",
				TokenIsEmpty: "缺少Token",
				NoResponseDataError: "无响应数据",
				Wait: "请稍等..."
			};
	</script>
</head>

<body>
	<div class="container">
		<p class="title">河南工业大学</p>
		<div class="box">
				<div id="login_box" style="display:none;visibility:hidden">
						<h2>校园网客户端</h2>		
						<div class="ui field">		
						学号：<input id="username" type="text" name="text"><br>
						</div>
						<div class="ui field">	
						密码：<input id="password" type="password" name="password"><br>
						</div>
						<div class="ui field">	
							保存信息：<input id="checkbox"" type="checkbox" name="checkbox" value="save" />（正在开发请等待）<br>
						</div>
						<div class="m">
							<button class="ui button" type="submit" onclick="Login()">&nbsp;登&nbsp;陆&nbsp;</button>
						</div>
				</div>
				<div id="logout_box" style="display:none;visibility:hidden">
					<h2>您已经在线</h2>		
					<h3>用户名: <span id="user_name"></span></h3>
					<h3>已用流量: <span id="used_flow"></span></h3>
					<h3>已用时长: <span id="used_time">请等待...</span></h3>
					<h3>IP地址: <span id="ip"></span></h3>
					<div  style="display:none">
						<div class="ui field">
						学号：<input id="username1" type="text" name="text" value =""><br>
						</div>
						<div class="ui field">	
						密码：<input id="password1" type="password" name="password" value =""><br>
						</div>
					</div>
					<div class="m">
						<button class="ui red button" type="submit" onclick="Logout()">&nbsp;注&emsp;销&nbsp;</button>
						<button class="ui button" type="submit" onclick="selfService()">自助服务</button>
					</div>
				</div>
				<!-- <div id="message_box">
					<h2>公告信息</h2>
					<h3><span id="title"></span></h3>	
					<h3><span id="content"></span></h3>	
					<div class="m">
						<button class="ui button" type="submit" onclick="ShowBox()">&nbsp;确&nbsp;定&nbsp;</button>
					</div>
				</div> -->
				<div id="error_box" style="display:none;visibility:hidden">
						<h2>您的网络连接似乎有问题</h2>
						<h3><span>无法连接到认证服务器！</span></h3>	
						<h3><span>请检查网络连接！</span></h3>	
						<div class="m">
							<button class="ui red button" type="submit" onclick="window.location.reload()">&nbsp;重&nbsp;试&nbsp;</button>
						</div>
				</div>
			<br><p>请右键另存为到本地后使用</p>
			<pre><div id="statusbar">欢迎使用网页版校园网登陆器！</div></pre>
		</div>
	</div>
	<br><br>
	<p class="foot">Srun3k Client v2.0.0 © Authored by <b><font><a href="https://github.com/zeng-xs/srun3k-client/" target="_blank">Zengxs</a></font></b> | Beautified by <b><font><a href="https://www.noisky.cn/" target="_blank">Noisky</a></font></b></p>


</body></html>